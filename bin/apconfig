#!/bin/bash

if [ "$(whoami)" != "root" ]; then
	echo "Sorry, you are not root."
	exit 1
fi

if [ "$1" == "" ]; then
	echo "Usage: apconfig PASSPHRASE"
	exit 1
fi

IN="$(iw dev | grep Interface | awk '{print $2}')"
NETCTL="netctl-auto@${IN}.service"

systemctl stop $NETCTL

OUT="$(ip route ls | grep default | awk '{print $5}')"

CONFDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd ../config-files && pwd )"
HOSTAPDCONF="${CONFDIR}/hostapd-${IN}.conf"
DNSCONF="${CONFDIR}/dnsmasq-${IN}.conf"


EMPTY="echo -e \n\n"

clear
$EMPTY
echo "Add MAC addresses of allowed devices in ~/.dotfiles/config-files/hostapd.accept"
$EMPTY


ip addr add 10.0.0.1/24 dev $IN

wait

sysctl net.ipv4.ip_forward=1 1> /dev/null

cat << EOF > $DNSCONF
no-resolv
interface=${IN}
dhcp-range=10.0.0.3,10.0.0.20,12h
server=8.8.8.8
server=8.8.4.4
EOF

cat << EOF > $HOSTAPDCONF
ssid=$(hostname)-AP
interface=${IN}
driver=nl80211
auth_algs=1
macaddr_acl=1
accept_mac_file=${CONFDIR}/hostapd.accept
hw_mode=g
ieee80211n=1
max_num_sta=5
channel=${2:-7}
ignore_broadcast_ssid=0
wpa=3
wpa_passphrase=$1
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP CCMP
rsn_pairwise=CCMP
EOF
wait

dnsmasq --conf-file=$DNSCONF 1> /dev/null

iptables --flush
iptables --table nat --flush
iptables --delete-chain
iptables --table nat --delete-chain
iptables --table nat --append POSTROUTING --out-interface $OUT --jump MASQUERADE
iptables --append FORWARD --in-interface $IN --jump ACCEPT

sysctl -w net.ipv4.ip_forward=1

wait

hostapd -B $HOSTAPDCONF 1> /dev/null

echo "Press ENTER to exit"
read dummy_keypress

rm -f $DNSCONF $HOSTAPDCONF
killall dnsmasq
iptables -F
ip addr del 10.0.0.1/24 dev $IN
clear

echo "Access Point has been stopped!"
systemctl start $NETCTL
