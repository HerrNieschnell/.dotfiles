#!/bin/bash
# add ip to client!

if [ "$(whoami)" != "root" ]; then
	echo "Sorry, you are not root."
	exit 1
fi

INTERFACE="$(iw dev | grep Interface | awk '{print $2}')"
CLIENT="${INTERFACE}.client"
AP="${INTERFACE}.ap"
HOSTAPDCONF=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd ../system && pwd )

echo "$HOSTAPDCONF"
echo "Adding virtual wlan interfaces"
echo ""
echo "Setting MAC adress"
echo ""
echo ""
echo ""
echo "On Client device set static IP 192.168.123.100!"
echo ""
echo "Edit settings in ~/.dotfiles/system/hostapd.conf"
echo "Add alowed devices in ~/.dotfiles/system/hostapd.accept"

systemctl stop netctl-auto@${INTERFACE}.service
iw dev wlp3s0 interface add $CLIENT type station
iw dev wlp3s0 interface add $AP type __ap
wait
ip link set dev $CLIENT address 00:19:e3:01:ed:95
wait
netctl start ${1:-ANAE_CL1}
ip link set $AP up
ip addr add 192.168.123.100/24 dev $AP

wait

sysctl net.ipv4.ip_forward=1
iptables -t nat -A POSTROUTING -o internet0 -j MASQUERADE
iptables -A FORWARD -i net0 -o internet0 -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

wait

hostapd -B ${HOSTAPDCONF}.conf

echo ""
echo ""
echo "Press any key to exit"
read keypress
echo ""
echo "Deleting virtual interfaces!"
echo ""
echo "Restarting systemd services!"
echo ""
echo ""
echo ""
echo "Stopping script!"

netctl stop ${1:-ANAE_CL1}
ip link set down $AP
iw dev $CLIENT del
iw dev $AP del

systemctl start netctl-auto@${INTERFACE}.service
